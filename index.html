<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Production Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #121212;
      --card-bg: rgba(255,255,255,0.07);
      --text: #EEE;
      --subtext: #BBB;
      --primary: #00BCD4;
      --aztech:rgb(170, 10, 238);
      --nilpeter:rgb(0, 152, 212);
      --nilpeter13:rgb(233, 220, 30);
      --eti: #FF1493;
      --slitter:rgb(210, 244, 245);
      --aztech13:rgb(18, 230, 145);
      --danger: #E53935;
      --safe: #43A047;
    }
    body {
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.7rem;
    }
    .company-footage-bar {
      width: 98vw; max-width: 1200px; margin: 0 auto 1rem auto;
      background: #232f36; border-radius: 0.7rem; box-shadow: 0 1.5px 10px 0 rgba(0,188,212,0.10);
      padding: 0.7rem 1rem 0.85rem 1rem;
      display: flex; flex-direction: column; align-items: stretch; position: relative; z-index: 2;
    }
    .company-footage-main { display: flex; align-items: baseline; gap: 0.7rem; font-size: 1.33rem; font-weight: 800; color: var(--primary); margin-bottom: 0.15rem; flex-wrap: wrap;}
    .big-number { font-size: 2.1rem; font-weight: 900; color: var(--primary); min-width: 105px; text-align: right; }
    .company-goal-bar { width: 100%; background: #223239; border-radius: 0.45rem; height: 1.18rem; overflow: hidden; margin-top: 0.19rem; position: relative; display: flex; }
    .goal-fill-nilpeter, .goal-fill-aztech, .goal-fill-eti, .goal-fill-aztech13, .goal-fill-slitter { height: 100%; position: absolute; top: 0; z-index: 1; transition: width 0.7s cubic-bezier(.4,2,.3,1);}
    .goal-fill-nilpeter { background: var(--nilpeter); border-radius: 0.45rem 0 0 0.45rem; left: 0; }
    .goal-fill-aztech { background: var(--aztech); }
    .goal-fill-eti { background: var(--eti); }
    .goal-fill-aztech13 { background: var(--aztech13);}
    .goal-fill-slitter { background: var(--slitter);}
    .goal-percent-label { position: absolute; right: 1.2rem; top: 50%; transform: translateY(-50%); color: #fff; font-weight: 700; font-size: 0.95rem; z-index: 2; text-shadow: 0 1px 6px #0008; }
    .dashboard-main-flex { width: 98vw; max-width: 1200px; display: flex; gap: 1.2rem; align-items: flex-start; justify-content: center; flex-wrap: wrap;}
    .chart-panel { flex: 3 1 350px; max-width: 100%; min-width: 280px;}
    .chart-card { background: var(--card-bg); border-radius: 1.2rem; padding: 1rem 1.2rem; margin-bottom: 0.2rem; }
    #footageChart { width: 100% !important; height: 500px !important; }
    .speed-cards-container { display: flex; flex-direction: column; gap: 1.2rem; min-width: 220px; max-width: 400px; width: 100%; }
    .card.speed-card {
      flex: 1 1 0;
      min-width: 170px; width: 100%; text-align: center; position: relative;
      padding: 0.65rem 0.7rem 0.4rem 0.7rem;
      background: var(--card-bg); border-radius: 1rem; box-shadow: 0 4px 30px rgba(0,0,0,0.19);
      margin-bottom: 0.08rem; transition: box-shadow 0.6s, border 0.6s;
      box-sizing: border-box;
    }
    .speed-card.danger {
      box-shadow: 0 0 24px 4px var(--danger), 0 1.5px 10px 0 rgba(0,0,0,0.17);
      border: 2.8px solid var(--danger);
      animation: card-glow 1.25s alternate infinite;
    }
    @keyframes card-glow {
      0%   { box-shadow: 0 0 24px 4px var(--danger), 0 1.5px 10px 0 rgba(0,0,0,0.12);}
      100% { box-shadow: 0 0 48px 9px var(--danger), 0 1.5px 20px 0 rgba(0,0,0,0.14);}
    }
    .press-header-row { display: flex; align-items: center; justify-content: space-between; gap: 0.7rem; font-size: 1.1rem; margin-bottom: 0.18rem;}
    .press-name-strong { font-weight: 800; font-size: 1rem; }
    .total-footage-strong { font-size: 1.23rem; font-weight: 900; color: var(--primary);}
    .speed-row { display: flex; align-items: center; justify-content: space-between; gap: 0.6rem; margin-bottom: 0.1rem; flex-direction: row-reverse; }
    .speed-indicator { width: 14px; height: 14px; border-radius: 50%; border: 1.2px solid #202628; display: inline-block; transition: background 1.2s, box-shadow 1.2s;}
    .speed-indicator.red { background: #E53935; animation: speedpulse-red 2.2s cubic-bezier(.5,0,.5,1) infinite alternate;}
    .speed-indicator.yellow { background: #FDD835; animation: speedpulse-yellow 1s cubic-bezier(.6,.2,0,1) infinite alternate;}
    .speed-indicator.green { background: #43A047; animation: speedpulse-green 1s cubic-bezier(.6,.2,0,1) infinite alternate;}
    .speed-indicator.bright-green { background: #32fc6c; animation: speedpulse-bright 1s cubic-bezier(.6,.2,0,1) infinite alternate;}
    @keyframes speedpulse-red {0%{box-shadow:0 0 4px 1px #e5393550;}55%{box-shadow:0 0 22px 8px #e53935fa;}100%{box-shadow:0 0 10px 4px #e5393585;}}
    @keyframes speedpulse-yellow {0%{box-shadow:0 0 1.5px 0px #fdd83545;}60%{box-shadow:0 0 8px 3px #fdd835a0;}100%{box-shadow:0 0 4px 1px #fdd8357a;}}
    @keyframes speedpulse-green {0%{box-shadow:0 0 1.5px 0px #43a04734;}60%{box-shadow:0 0 7px 2.5px #43a04785;}100%{box-shadow:0 0 3.5px 1px #43a0474d;}}
    @keyframes speedpulse-bright {0%{box-shadow:0 0 2px 0.5px #56ff9260;}60%{box-shadow:0 0 8.5px 3px #56ff92b7;}100%{box-shadow:0 0 5.5px 2px #56ff927a;}}
    .speed-value { font-size: 1.18rem; font-weight: 900; min-width: 46px; text-align: right; }
    .progress-bar { flex: 1; height: 0.55rem; background: #333; border-radius: 0.25rem; overflow: hidden; margin-right: 0.5rem; min-width: 40px;}
    .progress-bar .fill { height: 100%; width: 0; transition: width 1s, background 0.5s;}
    .fill.red { background: #E53935 !important; }
    .fill.yellow { background: #FDD835 !important; }
    .fill.green { background: #43A047 !important; }
    .fill.bright-green { background: #32fc6c !important; }
    .downtime-total-label { display: flex; align-items: center; justify-content: center; gap: 0.32em; font-size: 1rem; color: var(--subtext); font-weight: 700; margin-top: 0.18rem; }
    .downtime-icon { display: inline-block; vertical-align: middle; font-size: 1.3em; color: #FDD835; margin-right: 0.12em; filter: drop-shadow(0 1px 1.2px #0007); }
    .down-warning {
      color: var(--danger); font-weight: 800; font-size: 1.04rem; margin: 0.25rem 0 0.09rem 0;
      letter-spacing: 0.02em; text-shadow: 0 2px 8px #e5393523; animation: card-glow 1.05s alternate infinite;
      display: flex; align-items: center; justify-content: center; gap: 0.2em;
    }
    @media (max-width: 1000px) {
      .dashboard-main-flex { flex-direction: column; gap: 1.2rem; }
      .chart-panel, .speed-cards-container { max-width: 100vw; }
    }
    @media (max-width: 650px) {
      .company-footage-bar, .speed-cards-container { max-width: 100vw; min-width: unset; }
      .speed-card { min-width: 98vw; max-width: 100vw;}
      .company-footage-main { font-size: 1rem; flex-direction: column;}
      .big-number { font-size: 1.45rem; min-width: 70px;}
      #footageChart { height: 220px !important; }
      .chart-card { padding: 0.3rem 0.2rem; }
      .speed-row { flex-direction: column-reverse; gap: 0.2rem; }
      .progress-bar { margin: 0; width: 100%; min-width: unset; }
      .speed-value { text-align: center; }
    }
    .goal-hit, .goal-over {
      background: var(--card-bg); color: #ffd700 !important;
      box-shadow: 0 0 16px 4px #ffd70080, 0 0 0px 0px #fff8dc00; border-radius: 0.7rem; transition: box-shadow 0.8s;
    }
    .goal-hit .goal-percent-label, .goal-over .goal-percent-label {
      color: #ffd700 !important; text-shadow: 0 0 6px #ffd70077, 0 0 12px #fff8dc33;
    }
    #company-footage-message .goal-hit, #company-footage-message .goal-over {
      font-weight: 800; color: #ffd700; text-shadow: 0 0 10px #ffd70044, 0 0 16px #fff8dc44;
    }
  </style>
</head>
<body>
  <div class="company-footage-bar" id="company-footage-bar">
    <div class="company-footage-main" id="company-footage-main">
      <span>Total Company Footage:</span>
      <span class="big-number" id="company-footage-val">0</span>
      <span id="company-footage-message" style="font-size:1.05rem;"></span>
    </div>
    <div class="company-goal-bar" id="company-goal-bar">
      <div class="goal-fill-eti" id="goal-fill-eti"></div>
      <div class="goal-fill-nilpeter" id="goal-fill-nilpeter"></div>
      <div class="goal-fill-aztech" id="goal-fill-aztech"></div>
      <div class="goal-fill-aztech13" id="goal-fill-aztech13"></div>
      <div class="goal-fill-slitter" id="goal-fill-slitter"></div>
      <span class="goal-percent-label" id="goal-percent-label">0%</span>
    </div>
  </div>

  <div class="dashboard-main-flex">
    <div class="speed-cards-container">
      <!-- ETI -->
      <div class="card speed-card" id="speed-widget-ETI" onclick="window.location.href='press_eti.html'">
        <div class="press-header-row">
          <span id="speed-indicator-ETI" class="speed-indicator"></span>
          <span class="press-name-strong" id="press-name-ETI">ETI</span>
          <span class="total-footage-strong big-number" id="total-footage-ETI">0</span>
        </div>
        <div class="speed-row">
          <span id="speed-value-ETI" class="speed-value big-number">0</span>
          <div class="progress-bar"><div id="speed-fill-ETI" class="fill"></div></div>
        </div>
        <span id="total-downtime-ETI" class="downtime-total-label"></span>
        <div id="down-warning-ETI" class="down-warning" style="display:none;"></div>
      </div>
      <!-- 17" Nilpeter -->
      <div class="card speed-card" id="speed-widget-17">
        <div class="press-header-row">
          <span id="speed-indicator-17" class="speed-indicator"></span>
          <span class="press-name-strong" id="press-name-17">17" Nilpeter</span>
          <span class="total-footage-strong big-number" id="total-footage-17">0</span>
        </div>
        <div class="speed-row">
          <span id="speed-value-17" class="speed-value big-number">0</span>
          <div class="progress-bar"><div id="speed-fill-17" class="fill"></div></div>
        </div>
        <span id="total-downtime-17" class="downtime-total-label"></span>
        <div id="down-warning-17" class="down-warning" style="display:none;"></div>
      </div>
      <!-- 18" Aztech -->
      <div class="card speed-card" id="speed-widget-18">
        <div class="press-header-row">
          <span id="speed-indicator-18" class="speed-indicator"></span>
          <span class="press-name-strong" id="press-name-18">18" Aztech</span>
          <span class="total-footage-strong big-number" id="total-footage-18">0</span>
        </div>
        <div class="speed-row">
          <span id="speed-value-18" class="speed-value big-number">0</span>
          <div class="progress-bar"><div id="speed-fill-18" class="fill"></div></div>
        </div>
        <span id="total-downtime-18" class="downtime-total-label"></span>
        <div id="down-warning-18" class="down-warning" style="display:none;"></div>
      </div>
      <!-- 13AZTECH -->
      <div class="card speed-card" id="speed-widget-13AZTECH">
        <div class="press-header-row">
          <span id="speed-indicator-13AZTECH" class="speed-indicator"></span>
          <span class="press-name-strong" id="press-name-13AZTECH">13AZTECH</span>
          <span class="total-footage-strong big-number" id="total-footage-13AZTECH">0</span>
        </div>
        <div class="speed-row">
          <span id="speed-value-13AZTECH" class="speed-value big-number">0</span>
          <div class="progress-bar"><div id="speed-fill-13AZTECH" class="fill"></div></div>
        </div>
        <span id="total-downtime-13AZTECH" class="downtime-total-label"></span>
        <div id="down-warning-13AZTECH" class="down-warning" style="display:none;"></div>
      </div>
      <!-- 13NILPETER -->
      <div class="card speed-card" id="speed-widget-13NILPETER">
        <div class="press-header-row">
          <span id="speed-indicator-13NILPETER" class="speed-indicator"></span>
          <span class="press-name-strong" id="press-name-13NILPETER">13NILPETER</span>
          <span class="total-footage-strong big-number" id="total-footage-13NILPETER">0</span>
        </div>
        <div class="speed-row">
          <span id="speed-value-13NILPETER" class="speed-value big-number">0</span>
          <div class="progress-bar"><div id="speed-fill-13NILPETER" class="fill"></div></div>
        </div>
        <span id="total-downtime-13NILPETER" class="downtime-total-label"></span>
        <div id="down-warning-13NILPETER" class="down-warning" style="display:none;"></div>
      </div>
      <!-- SLITTER -->
      <div class="card speed-card" id="speed-widget-SLITTER">
        <div class="press-header-row">
          <span id="speed-indicator-SLITTER" class="speed-indicator"></span>
          <span class="press-name-strong" id="press-name-SLITTER">SLITTER</span>
          <span class="total-footage-strong big-number" id="total-footage-SLITTER">0</span>
        </div>
        <div class="speed-row">
          <span id="speed-value-SLITTER" class="speed-value big-number">0</span>
          <div class="progress-bar"><div id="speed-fill-SLITTER" class="fill"></div></div>
        </div>
        <span id="total-downtime-SLITTER" class="downtime-total-label"></span>
        <div id="down-warning-SLITTER" class="down-warning" style="display:none;"></div>
      </div>
    </div>

    <div class="chart-panel">
      <div class="chart-card">
        <h2 style="color:var(--subtext);font-size:1.15rem;margin:0 0 0.3em 0;font-weight:600;">Daily Footage</h2>
        <canvas id="footageChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  // ======= CONFIG =======
  const COMPANY_GOAL = 300000;
  const REPORT_INTERVAL_SEC = 10;          // server reporting cadence
  const DOWNTIME_THRESHOLD = 0.01;
  const REQUEST_TIMEOUT_MS = 6000;
  const MAX_POINTS_INITIAL = 4000;         // safety cap on first load
  const MAX_POINTS_INCREMENTAL = 300;      // cap per poll after first load
  const POLL_MS = 10000;                   // starting poll interval

  // ======= SHIFT WINDOW (6:00 AM -> 2:30 AM next day) =======
  function getShiftWindow() {
    const now = new Date();
    const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
    const start = new Date(base); start.setHours(6,0,0,0);
    const end = new Date(start); end.setDate(start.getDate()+1); end.setHours(2,30,0,0);
    return { start, end, now };
  }

  // ======= DATA SOURCES =======
  function css(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
  const PRESSES = [
    { name: 'ETI', id: 'ETI', color: css('--eti'),
      SPEED_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/ETI_CURRENT_SPEED.json',
      FOOTAGE_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/ETI_DAILY_SPEED.json' },
    { name: '17\" Nilpeter', id: '17', color: css('--nilpeter'),
      SPEED_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/17Nilpeter_CURRENT_SPEED.json',
      FOOTAGE_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/17Nilpeter_DAILY_SPEED.json' },
    { name: '18\" Aztech', id: '18', color: css('--aztech'),
      SPEED_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/18Aztech_CURRENT_SPEED.json',
      FOOTAGE_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/18Aztech_DAILY_SPEED.json' },
    { name: '13AZTECH', id: '13AZTECH', color: css('--aztech13'),
      SPEED_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/13AZTECH_CURRENT_SPEED.json',
      FOOTAGE_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/13AZTECH_DAILY_SPEED.json' },
    { name: '13NILPETER', id: '13NILPETER', color: css('--nilpeter13'),
      SPEED_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/13NILPETER_CURRENT_SPEED.json',
      FOOTAGE_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/13NILPETER_DAILY_SPEED.json' },
    { name: 'SLITTER', id: 'SLITTER', color: css('--slitter'),
      SPEED_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/SLITTER_CURRENT_SPEED.json',
      FOOTAGE_URL: 'https://realtime-database-8bbe2-default-rtdb.firebaseio.com/SLITTER_DAILY_SPEED.json' },
  ];

  // ======= STATE (per press) for incremental fetches =======
  const pressState = {}; // id -> { lastTs:number|null, cum:number, points:Array<{x,y}> }
  PRESSES.forEach(p => pressState[p.id] = { lastTs: null, cum: 0, points: [] });

  // ======= FETCH HELPERS =======
  function buildFootageURL(baseUrl, startSec, endSec, limitToLast) {
    const params = new URLSearchParams({
      orderBy: '"timestamp"',
      startAt: String(startSec),
      endAt: String(endSec),
      limitToLast: String(limitToLast)
    });
    return `${baseUrl}?${params.toString()}`;
  }

  // ---- ETag cache for conditional GETs (huge savings when unchanged) ----
  const etags = new Map(); // key: full URL (including query), value: ETag string

  async function fetchJSON_ETag(url, timeoutMs = REQUEST_TIMEOUT_MS) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);

    const headers = { 'X-Firebase-ETag': 'true' };
    const prev = etags.get(url);
    if (prev) headers['If-None-Match'] = prev;

    try {
      const res = await fetch(url, { headers, signal: ctrl.signal, cache: 'no-store' });

      if (res.status === 304) {
        // unchanged ‚Üí near-zero billed bytes + we skip work
        return { unchanged: true, data: null };
      }

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const etag = res.headers.get('ETag');
      if (etag) etags.set(url, etag);

      const data = await res.json();
      return { unchanged: false, data };
    } finally { clearTimeout(t); }
  }

  // ======= DATA CLEANUP =======
  function cleanEntries(raw, dStartMs, dEndMs) {
    return Object.values(raw || {})
      .map(v => (v && v.timestamp!=null && v.footage!=null) ? { ts: Number(v.timestamp)*1000, footage: Number(v.footage) } : null)
      .filter(e => e && e.ts >= dStartMs && e.ts < dEndMs)
      .sort((a,b) => a.ts - b.ts);
  }

  // ======= CHART =======
  let footageChart;
  function setupFootageChart() {
    const ctx = document.getElementById('footageChart').getContext('2d');
    footageChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: PRESSES.map(press => ({
          label: press.name,
          data: [],
          fill: false,
          borderWidth: 2,
          tension: 0.3,
          borderColor: press.color,
          pointRadius: 0,
          pointHoverRadius: 0,
          pointBackgroundColor: press.color
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true } },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'hour', displayFormats: { hour: 'ha' } },
            ticks: { color: css('--text') },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          y: {
            ticks: { color: css('--text'), font: { size: 16 } },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        },
        animation: { duration: 220, easing: 'easeOutQuart' }
      }
    });
  }

  // ======= UI ANIMS =======
  function animateNumber(el, to, duration=7000) {
    const from = Number((el.textContent || "0").replace(/,/g,"")) || 0;
    if (Math.abs(to - from) < 1) { el.textContent = to.toLocaleString(); return; }
    const start = performance.now();
    function step(now) {
      const t = Math.min((now - start) / duration, 1);
      const eased = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
      const val = Math.round(from + (to - from) * eased);
      el.textContent = val.toLocaleString();
      if (t < 1) requestAnimationFrame(step);
      else el.textContent = Math.round(to).toLocaleString();
    }
    requestAnimationFrame(step);
  }

  // ======= RENDER HELPERS =======
  function byId(id){ return document.getElementById(id); }
  function getDisplayedNumber(el){ return Number(String(el?.textContent||'0').replace(/,/g,''))||0; }

  function updateSpeedCard(press, speed, totalFootage, totalDowntimeMin, currentDownMin, isDown) {
    const speedEl = byId('speed-value-' + press.id);
    const tfEl = byId('total-footage-' + press.id);
    const nameEl = byId('press-name-' + press.id);
    const indEl = byId('speed-indicator-' + press.id);
    const fillEl = byId('speed-fill-' + press.id);
    const dtLabel = byId('total-downtime-' + press.id);
    const warnEl = byId('down-warning-' + press.id);
    const card = byId('speed-widget-' + press.id);

    animateNumber(speedEl, Math.round(speed), 7000);
    animateNumber(tfEl, Math.round(totalFootage), 10000);
    nameEl.style.color = press.color; tfEl.style.color = press.color;

    indEl.className = "speed-indicator";
    fillEl.className = "fill";
    let cls = "red";
    if (speed === 0) cls = "red";
    else if (speed < 150) cls = "yellow";
    else if (speed < 300) cls = "green";
    else cls = "bright-green";
    indEl.classList.add(cls); fillEl.classList.add(cls);

    const pct = Math.min(speed / 700 * 100, 100) + '%';
    fillEl.style.width = pct;
    speedEl.style.color = getComputedStyle(fillEl).backgroundColor;

    dtLabel.innerHTML = `<span class="downtime-icon">‚è±Ô∏è</span> ${
      totalDowntimeMin < 60
        ? `${Math.round(totalDowntimeMin)} min`
        : `${(totalDowntimeMin/60)%1===0 ? (totalDowntimeMin/60) : (totalDowntimeMin/60).toFixed(1)} hour${totalDowntimeMin>=120?"s":""}`
    }`;

    if (isDown && currentDownMin >= 30) {
      warnEl.textContent = `Down ${currentDownMin} min`;
      warnEl.style.display = 'flex';
      card.classList.add('danger');
    } else {
      warnEl.textContent = '';
      warnEl.style.display = 'none';
      card.classList.remove('danger');
    }
  }

  function updateCompanyBar(totals) {
    const total = totals.reduce((a,b)=>a+b,0);
    const percent = Math.min((total / COMPANY_GOAL) * 100, 999.9);

    const shares = total ? totals.map(x => x/total*100) : totals.map(_=>0);
    const ids = ['eti','nilpeter','aztech','aztech13','slitter'];
    const fills = ids.map(id => byId('goal-fill-'+id));

    // left positions for stacked bar
    let leftPct = 0;
    for (let i=0;i<fills.length;i++){
      fills[i].style.left = (percent * (leftPct/100)) + '%';
      fills[i].style.width = (percent * (shares[i]/100)) + '%';
      leftPct += shares[i] || 0;
    }

    byId('goal-percent-label').textContent = percent.toFixed(0)+'%';
    animateNumber(byId('company-footage-val'), Math.round(total), 10000);

    const msg = byId('company-footage-message');
    const bar = byId('company-goal-bar');
    const head = byId('company-footage-main');
    const val = byId('company-footage-val');
    [bar, head, val].forEach(el => { el.classList.remove('goal-hit','goal-over'); });
    msg.innerHTML = '';

    if (total >= COMPANY_GOAL * 1.10) {
      [bar, head, val].forEach(el => el.classList.add('goal-over'));
      msg.innerHTML = `<span class="goal-over">Over Goal! üéâ</span>`;
    } else if (total >= COMPANY_GOAL) {
      [bar, head, val].forEach(el => el.classList.add('goal-hit'));
      msg.innerHTML = `<span class="goal-hit">Goal Hit! üöÄ</span>`;
    } else {
      msg.innerHTML = `<span style="color:#bbb;font-weight:500;font-size:1rem;">Goal: ${COMPANY_GOAL.toLocaleString()} ft</span>`;
    }
  }

  // ======= DOWNTIME COMPUTE =======
  function computeDowntime(arr, startMs, endMs, nowMs) {
    const intervalMs = REPORT_INTERVAL_SEC * 1000;
    let totalDowntimeMin = 0;
    let currentDownMin = 0;
    let isDown = false;

    // last non-zero footage timestamp
    let lastUpTs = null;
    for (let i = arr.length - 1; i >= 0; i--) {
      if (arr[i].footage > DOWNTIME_THRESHOLD) { lastUpTs = arr[i].ts; break; }
    }

    if (arr.length === 0 || arr[arr.length-1].footage <= DOWNTIME_THRESHOLD) {
      isDown = true;
      const downSince = lastUpTs ?? startMs;
      currentDownMin = Math.round((Math.min(nowMs, endMs) - downSince) / 60000);
    }

    let timePtr = startMs;
    let idx = 0;
    while (timePtr < nowMs && timePtr < endMs) {
      const windowEnd = timePtr + intervalMs;
      let rec = arr[idx];
      let down = true; // assume down if no record in window
      if (rec && rec.ts >= timePtr && rec.ts < windowEnd) {
        down = !(rec.footage > DOWNTIME_THRESHOLD);
        idx++;
      }
      if (down) totalDowntimeMin += REPORT_INTERVAL_SEC / 60;
      timePtr = windowEnd;
    }

    return { totalDowntimeMin, currentDownMin, isDown };
  }

  // ======= MAIN FETCH LOOP (ETag + incremental) =======
  async function refreshAll() {
    let anyChange = false; // track if anything changed this cycle

    const { start, end, now } = getShiftWindow();
    const startSec = Math.floor(start.getTime()/1000);
    const endSec = Math.floor(Math.min(now.getTime(), end.getTime())/1000);

    const pressesResults = await Promise.all(PRESSES.map(async (press) => {
      // incremental window
      const lastTs = pressState[press.id].lastTs;
      const incrementalStartSec = lastTs ? Math.floor(lastTs/1000) + 1 : startSec;

      // cap downloads
      const expectedPoints = Math.ceil((endSec - incrementalStartSec) / REPORT_INTERVAL_SEC) + 5;
      const limitToLast = Math.min(
        lastTs ? MAX_POINTS_INCREMENTAL : MAX_POINTS_INITIAL,
        Math.max(0, expectedPoints)
      );

      const footageURL = buildFootageURL(press.FOOTAGE_URL, incrementalStartSec, endSec, limitToLast);

      // ETag-aware requests (huge savings when unchanged)
      const [speedRes, footageRes] = await Promise.all([
        fetchJSON_ETag(press.SPEED_URL).catch(() => ({ unchanged: true, data: null })),
        fetchJSON_ETag(footageURL).catch(() => ({ unchanged: true, data: null }))
      ]);

      return { press, speedRes, footageRes, start, end, now };
    }));

    const totals = [];

    pressesResults.forEach(({ press, speedRes, footageRes, start, end, now }) => {
      const state = pressState[press.id];

      // Only process footage if changed; otherwise skip work and DOM writes
      const cleaned = footageRes.unchanged
        ? []
        : cleanEntries(footageRes.data, start.getTime(), end.getTime());

      if (!footageRes.unchanged && cleaned.length) {
        anyChange = true;
        if (state.lastTs == null) { state.cum = 0; state.points = []; }
        cleaned.forEach(e => {
          state.cum += e.footage;
          state.points.push({ x: new Date(e.ts), y: state.cum });
          state.lastTs = e.ts;
        });
        if (state.points.length > MAX_POINTS_INITIAL) {
          state.points.splice(0, state.points.length - MAX_POINTS_INITIAL);
        }
        const dsIndex = PRESSES.findIndex(p => p.id === press.id);
        if (dsIndex !== -1) {
          footageChart.data.datasets[dsIndex].data = state.points;
        }
      }

      // Speed (cheap; still ETag'd). If unchanged, keep displayed value.
      let currentSpeed;
      if (speedRes.unchanged) {
        currentSpeed = getDisplayedNumber(byId('speed-value-' + press.id));
      } else {
        anyChange = true;
        currentSpeed = Number(speedRes.data?.currentSpeed || 0);
      }

      // Downtime: recompute only when footage changed; otherwise skip heavy math
      const { totalDowntimeMin, currentDownMin, isDown } =
        cleaned.length
          ? computeDowntime(cleaned, start.getTime(), end.getTime(), now.getTime())
          : { totalDowntimeMin: 0, currentDownMin: 0, isDown: false };

      totals.push(pressState[press.id].cum || 0);
      updateSpeedCard(press, currentSpeed, pressState[press.id].cum || 0, totalDowntimeMin, currentDownMin, isDown);
    });

    updateCompanyBar(totals);
    if (anyChange) footageChart.update();

    return anyChange; // tells the adaptive poller whether to back off or speed up
  }

  // ======= ADAPTIVE POLLER (backs off when unchanged) =======
  let pollTimer = null;
  let currentInterval = POLL_MS;
  let unchangedStreak = 0;
  const MIN_POLL_MS = 5000;     // fastest we'll go
  const MAX_POLL_MS = 60000;    // slowest we'll go (1 min)

  function scheduleNext() {
    if (pollTimer) clearTimeout(pollTimer);
    pollTimer = setTimeout(async () => {
      const changed = await refreshAll();
      if (changed) {
        unchangedStreak = 0;
        currentInterval = Math.max(MIN_POLL_MS, Math.floor(currentInterval * 0.5)); // speed up on change
      } else {
        unchangedStreak++;
        const factor = unchangedStreak < 3 ? 1.5 : 2.0; // gradually back off
        currentInterval = Math.min(MAX_POLL_MS, Math.floor(currentInterval * factor));
      }
      scheduleNext();
    }, currentInterval);
  }

  // Pause polling when the tab isn't visible (saves bytes & CPU)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (pollTimer) clearTimeout(pollTimer);
      pollTimer = null;
    } else {
      currentInterval = POLL_MS;
      unchangedStreak = 0;
      scheduleNext();
    }
  });

  // ======= BOOT =======
  setupFootageChart();
  currentInterval = POLL_MS;
  scheduleNext();
</script>

</body>
</html>
